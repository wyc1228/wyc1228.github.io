<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wyc1228.github.io","root":"/","scheme":"Gemini","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="Sentinel服务熔断，降级，限流">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud-10(Sentinel服务熔断，降级，限流)">
<meta property="og:url" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/index.html">
<meta property="og:site_name" content="wyc&#39;s blog">
<meta property="og:description" content="Sentinel服务熔断，降级，限流">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324083510525.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324083741442.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324090840460.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324091400897.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324091510395.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324091543018.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324093807089.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324093917245.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324094105085.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324094142605.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324094334537.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324094851901.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324100546541.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324100717609.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324102258489.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324103152037.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324103056164.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324103936005.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324104409676.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324105319560.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324105607787.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324110440987.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324133554619.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324134725942.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324135836455.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324141232594.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324141354890.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324141956227.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324142115868.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324142401530.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324142708044.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324142648446.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324143355535.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324143928282.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324143759722.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324144028937.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324150822616.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324151003428.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324151808585.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324153040177.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324153309437.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324154302335.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324154617818.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324154741268.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324155013852.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324155146013.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324160615707.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324160734940.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324161527888.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324161637020.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324164045293.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324164151463.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324164217160.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324164329276.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324164739589.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324183001040.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324183015615.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324200454067.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324200741518.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324200801379.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324201323581.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324201440608.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324201423890.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324202041834.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324202352729.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324202617127.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324202709809.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324202910696.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324203333500.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324203549954.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324203624772.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324203657736.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324203814377.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324204513619.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324204725384.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324205611681.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324210022034.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324211043247.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324210943831.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324211135489.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324212807465.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324212948486.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324213041319.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324213423416.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324213534477.png">
<meta property="og:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324213703263.png">
<meta property="article:published_time" content="2020-11-24T13:46:45.000Z">
<meta property="article:modified_time" content="2021-03-25T12:04:31.450Z">
<meta property="article:author" content="wyc">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wyc1228.github.io/2020/11/24/SpringCloud-10/image-20210324083510525.png">


<link rel="canonical" href="https://wyc1228.github.io/2020/11/24/SpringCloud-10/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>SpringCloud-10(Sentinel服务熔断，降级，限流) | wyc's blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">wyc's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringCloud-10"><span class="nav-text">SpringCloud-10</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81SpringCloud-Alibaba-Sentinel"><span class="nav-text">1、SpringCloud Alibaba Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Sentinel%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1 Sentinel概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Sentinel%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="nav-text">1.2 Sentinel的下载安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BC%94%E7%A4%BA%E5%B7%A5%E7%A8%8B"><span class="nav-text">1.3 初始化演示工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E6%B5%8B%E8%AF%95"><span class="nav-text">1.4 测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="nav-text">2、流控规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="nav-text">2.1 流控模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="nav-text">2.2 流控效果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="nav-text">3、降级规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-RT%E6%B5%8B%E8%AF%95"><span class="nav-text">3.1 RT测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="nav-text">3.2 异常比例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="nav-text">3.3 异常数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E7%83%AD%E7%82%B9Key%E9%99%90%E6%B5%81"><span class="nav-text">4、热点Key限流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9"><span class="nav-text">4.1 参数例外项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="nav-text">5、系统规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81-SentinelResource"><span class="nav-text">6、@SentinelResource</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%8C%89%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0%E9%99%90%E6%B5%81-%E5%90%8E%E5%BA%8F%E5%A4%84%E7%90%86"><span class="nav-text">6.1 按资源名称限流+后序处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%8C%89URL%E5%9C%B0%E5%9D%80%E9%99%90%E6%B5%81-%E5%90%8E%E5%BA%8F%E5%A4%84%E7%90%86"><span class="nav-text">6.2 按URL地址限流+后序处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="nav-text">6.3 用户自定义限流处理逻辑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E5%8A%9F%E8%83%BD"><span class="nav-text">7、服务熔断功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Ribbon%E7%B3%BB%E5%88%97"><span class="nav-text">7.1 Ribbon系列</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-1-%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E9%85%8D%E7%BD%AE"><span class="nav-text">7.1.1 没有任何配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-%E5%8F%AA%E9%85%8D%E7%BD%AEfallback"><span class="nav-text">7.1.2 只配置fallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-%E5%8F%AA%E9%85%8D%E7%BD%AEblockHandler"><span class="nav-text">7.1.3 只配置blockHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-4-%E4%B8%A4%E4%B8%AA%E9%83%BD%E9%85%8D%E7%BD%AE"><span class="nav-text">7.1.4 两个都配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-5-%E5%BC%82%E5%B8%B8%E5%BF%BD%E7%95%A5"><span class="nav-text">7.1.5 异常忽略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-OpenFeign%E7%B3%BB%E5%88%97"><span class="nav-text">7.2 OpenFeign系列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8%E3%80%81Sentinel%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">8、Sentinel持久化</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wyc"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">wyc</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://wyc1228.github.io/2020/11/24/SpringCloud-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="wyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wyc's blog">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud-10(Sentinel服务熔断，降级，限流)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-11-24 21:46:45" itemprop="dateCreated datePublished" datetime="2020-11-24T21:46:45+08:00">2020-11-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SpringCloud/" itemprop="url" rel="index"><span itemprop="name">SpringCloud</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">Sentinel服务熔断，降级，限流</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="SpringCloud-10"><a href="#SpringCloud-10" class="headerlink" title="SpringCloud-10"></a>SpringCloud-10</h1><h2 id="1、SpringCloud-Alibaba-Sentinel"><a href="#1、SpringCloud-Alibaba-Sentinel" class="headerlink" title="1、SpringCloud Alibaba Sentinel"></a>1、SpringCloud Alibaba Sentinel</h2><h3 id="1-1-Sentinel概述"><a href="#1-1-Sentinel概述" class="headerlink" title="1.1 Sentinel概述"></a>1.1 Sentinel概述</h3><p>官网：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki">https://github.com/alibaba/Sentinel/wiki</a></li>
</ul>
<p>是什么？</p>
<ul>
<li>轻量级的流量控制，熔断降级java库</li>
<li>就跟Hystrix功能一样</li>
</ul>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324083510525.png" alt="image-20210324083510525"></p>
<p>主要特性：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324083741442.png" alt="image-20210324083741442"></p>
<p>服务使用中的各种问题</p>
<ul>
<li>服务雪崩</li>
<li>服务降级</li>
<li>服务熔断</li>
<li>服务限流</li>
</ul>
<h3 id="1-2-Sentinel的下载安装"><a href="#1-2-Sentinel的下载安装" class="headerlink" title="1.2 Sentinel的下载安装"></a>1.2 Sentinel的下载安装</h3><p>Sentinel由后台和前台8080组成</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324090840460.png" alt="image-20210324090840460"></p>
<p>下载好Sentinel的jar包之后，直接<code>java -jar sentinel-dashboard-1.7.0.jar</code>运行。</p>
<p>前提是有java环境以及8080端口不能被占用<img src="/2020/11/24/SpringCloud-10/image-20210324091400897.png" alt="image-20210324091400897"></p>
<p>访问Sentinel管理界面：localhost:8080，账号密码均为sentinel</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324091510395.png" alt="image-20210324091510395"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324091543018.png" alt="image-20210324091543018"></p>
<h3 id="1-3-初始化演示工程"><a href="#1-3-初始化演示工程" class="headerlink" title="1.3 初始化演示工程"></a>1.3 初始化演示工程</h3><p><strong>新建Module：</strong>cloudalibaba-sentinel-server8401</p>
<p>POM：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;cloud2020&lt;/artifactId&gt;
        &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;cloudalibaba-sentinel-server8401&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;
            &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;
            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--SpringCloud ailibaba nacos --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;
            &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--SpringCloud ailibaba sentinel --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--openfeign--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringBoot整合Web组件+actuator --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--日常通用jar包配置--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cn.hutool&lt;/groupId&gt;
            &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;
            &lt;version&gt;4.6.3&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<p>yml：</p>
<pre><code class="yml">server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #Nacos服务注册中心地址
    sentinel:
      transport:
        dashboard: localhost:8080 #配置Sentinel dashboard地址
        port: 8719

management:
  endpoints:
    web:
      exposure:
        include: &#39;*&#39;
</code></pre>
<p>主启动类：</p>
<pre><code class="java">package com.practice.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@EnableDiscoveryClient
@SpringBootApplication
public class MainApp8401
&#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(MainApp8401.class, args);
    &#125;
&#125;
</code></pre>
<p>业务类：controller</p>
<pre><code>@RestController
@Slf4j
public class FlowLimitController
&#123;
    @GetMapping(&quot;/testA&quot;)
    public String testA()
    &#123;
        return &quot;------testA&quot;;
    &#125;

    @GetMapping(&quot;/testB&quot;)
    public String testB()
    &#123;
        log.info(Thread.currentThread().getName()+&quot;\t&quot;+&quot;...testB&quot;);
        return &quot;------testB&quot;;
    &#125;
&#125;
</code></pre>
<h3 id="1-4-测试"><a href="#1-4-测试" class="headerlink" title="1.4 测试"></a>1.4 测试</h3><p>启动Nacos</p>
<p>在Nacos解压目录下用cmd启动startup.cmd</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324093807089.png" alt="image-20210324093807089"></p>
<p>在Sentinel的jar包目录下启动Sentinel的jar包</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324093917245.png" alt="image-20210324093917245"></p>
<p>然后启动8401项目</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324094105085.png" alt="image-20210324094105085"></p>
<p>此时刷新Sentinel网页端页面，发现什么也没有</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324094142605.png" alt="image-20210324094142605"></p>
<p>因为Sentinel采用的是懒加载，需要访问一次才有显示</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8401/testA">http://localhost:8401/testA</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8401/testB">http://localhost:8401/testB</a></li>
</ul>
<p>此时再查看网页端页面，发现有内容</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324094334537.png" alt="image-20210324094334537"></p>
<h2 id="2、流控规则"><a href="#2、流控规则" class="headerlink" title="2、流控规则"></a>2、流控规则</h2><p><img src="/2020/11/24/SpringCloud-10/image-20210324094851901.png" alt="image-20210324094851901"></p>
<p>资源名：唯一名称，默认请求路径</p>
<p>针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）</p>
<p>阈值类型/单机阈值：</p>
<ul>
<li>QPS（每秒钟请求数量）：当调用改api的QPS达到阈值的时候，进行限流</li>
<li>线程数：当调用该api的线程数达到阈值的时候，进行限流</li>
</ul>
<p>是否集群：不需要集群</p>
<p>流控模式：</p>
<ul>
<li>直接：api达到限流条件时，直接限流</li>
<li>关联：当关联的资源达到阈值时，就限流自己</li>
<li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）【api级别的针对来源】</li>
</ul>
<p>流控效果：</p>
<ul>
<li>快速失败：直接失败，抛异常</li>
<li>Warm Up：根据codeFactor（冷加载因子，默认3）的值，从阈值/codeFactor，经过预热时长，才达到设置的QPS阈值</li>
<li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须要设置为QPS，否则无效</li>
</ul>
<h3 id="2-1-流控模式"><a href="#2-1-流控模式" class="headerlink" title="2.1 流控模式"></a>2.1 流控模式</h3><p>直接（默认）：直接 -&gt; 快速失败</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324100546541.png" alt="image-20210324100546541"></p>
<p>此时表示1秒钟查询一次可以，若一秒钟查询次数超过1次，就直接-快速失败，报默认错误</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324100717609.png" alt="image-20210324100717609"></p>
<p>关联：当关联的资源达到阈值时，就限流自己</p>
<ul>
<li>当与A关联的资源B达到阈值后，就限流自己</li>
<li>(支付接口达到阈值后,就限流下订单的接口,防止连坐效应)</li>
</ul>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324102258489.png" alt="image-20210324102258489"></p>
<p>此时表示当B 1秒钟超过阈值1，就会将A挂掉。</p>
<p>测试，用postman模拟并发密集访问testB，此时再访问testA，发现A挂掉了</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324103152037.png" alt="image-20210324103152037"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324103056164.png" alt="image-20210324103056164"></p>
<p>链路：多个请求调用了同一个微服务</p>
<h3 id="2-2-流控效果"><a href="#2-2-流控效果" class="headerlink" title="2.2 流控效果"></a>2.2 流控效果</h3><p><strong>直接-&gt;快速失败</strong>(默认的流控处理)：直接失败，抛出异常</p>
<p><strong>预热：</strong></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324103936005.png" alt="image-20210324103936005"></p>
<p>公式:</p>
<ul>
<li>阈值除以coldFactor(默认值为3),经过预热时长后才会达到阈值</li>
<li>默认coldFactory为3，即请求QPS从threshold/3开始，经预热时长逐渐升至设定的QPS阈值</li>
</ul>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324104409676.png" alt="image-20210324104409676"></p>
<p>此时表示A的阈值为10，指最终效果是1秒钟最大访问次数为10，冷加载因子codeFactory默认为3，则最开始阈值为 10/3=3，通过预热时长5s慢慢增长到阈值10</p>
<p><strong>排队等待：</strong></p>
<p>匀速排队，让请求以均匀的速度通过，阈值类型必须设成QPS，否则无效</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324105319560.png" alt="image-20210324105319560"></p>
<p>此时表示A每秒10次请求，超过的话就排队等待，等待的超时时间为50000毫秒</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324105607787.png" alt="image-20210324105607787"></p>
<h2 id="3、降级规则"><a href="#3、降级规则" class="headerlink" title="3、降级规则"></a>3、降级规则</h2><p>Sentinel熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其他的资源而导致级联错误。</p>
<p>当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出DegradeException）</p>
<p>Sentinel的断路器<strong>没有半开</strong>状态的：</p>
<ul>
<li>半开的状态系统自动去检测是否请求异常, 没有异常就关闭断路器恢复使用,有异常则继续打开断路器不可用.具体可以参考Hystrix</li>
</ul>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324110440987.png" alt="image-20210324110440987"></p>
<p>RT（平均响应时间，秒级）</p>
<ul>
<li>平均响应时间 超出阈值 且 在时间窗口内通过的请求&gt;=5 ，两个条件同时满足后出发降级</li>
<li>窗口期过后关闭断路器</li>
<li>RT最大4900（更大需要通过-Dcsp.sentinel.statistic.max.rt=xxx才能生效）</li>
</ul>
<p>异常比例（秒级）</p>
<ul>
<li>QPS&gt;=5且异常比例（秒级统计）超过阈值时，触发降级；时间窗口结束后，关闭降级</li>
</ul>
<p>异常数（分钟级）</p>
<ul>
<li>异常数（分钟统计）超过阈值时，触发降级；时间窗口结束后，关闭降级</li>
</ul>
<h3 id="3-1-RT测试"><a href="#3-1-RT测试" class="headerlink" title="3.1 RT测试"></a>3.1 RT测试</h3><p>代码：</p>
<pre><code class="java">@RestController
@Slf4j
public class FlowLimitController
&#123;
    @GetMapping(&quot;/testA&quot;)
    public String testA()
    &#123;
        return &quot;------testA&quot;;
    &#125;

    @GetMapping(&quot;/testB&quot;)
    public String testB()
    &#123;
        log.info(Thread.currentThread().getName()+&quot;\t&quot;+&quot;...testB&quot;);
        return &quot;------testB&quot;;
    &#125;
    @GetMapping(&quot;/testD&quot;)
    public String testD()
    &#123;
        try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;
        log.info(&quot;testD 测试RT&quot;);
        
        return &quot;------testD&quot;;
    &#125;
&#125;
</code></pre>
<p>配置</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324133554619.png" alt="image-20210324133554619"></p>
<p>表示要求在200毫秒内处理异常，在未来的1秒钟以内如果没解决，就熔断，保护系统</p>
<p>JMeter压测：1秒发10个请求</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324134725942.png" alt="image-20210324134725942"></p>
<p>按照上述配置，永远1秒钟进来10个线程调用testD，我们希望200毫秒处理完本次服务，如果超过200毫秒还没处理完，在未来1秒钟的时间窗口内，断路器打开，微服务不可用</p>
<p>此时就会触发熔断</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324135836455.png" alt="image-20210324135836455"></p>
<h3 id="3-2-异常比例"><a href="#3-2-异常比例" class="headerlink" title="3.2 异常比例"></a>3.2 异常比例</h3><p><img src="/2020/11/24/SpringCloud-10/image-20210324141232594.png" alt="image-20210324141232594"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324141354890.png" alt="image-20210324141354890"></p>
<p>测试代码：</p>
<pre><code class="java">@RestController
@Slf4j
public class FlowLimitController
&#123;
    @GetMapping(&quot;/testA&quot;)
    public String testA()
    &#123;
        return &quot;------testA&quot;;
    &#125;

    @GetMapping(&quot;/testB&quot;)
    public String testB()
    &#123;
        log.info(Thread.currentThread().getName()+&quot;\t&quot;+&quot;...testB&quot;);
        return &quot;------testB&quot;;
    &#125;
    @GetMapping(&quot;/testD&quot;)
    public String testD()
    &#123;

        log.info(&quot;testD 异常比例&quot;);
        int age = 10/0;
        return &quot;------testD&quot;;
    &#125;
&#125;
</code></pre>
<p>配置</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324141956227.png" alt="image-20210324141956227"></p>
<p>此时触发熔断：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324142115868.png" alt="image-20210324142115868"></p>
<p>若没有触发降级将直接报错：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324142401530.png" alt="image-20210324142401530"></p>
<p>所以，按照上述配置，单独访问一次，必然来一次报错一次，开启JMeter后，直接高并发发送请求，多次调用达到我们的配置条件了。断路器开启（保险丝跳闸），微服务不可用了，不再报错error而是服务降级了</p>
<h3 id="3-3-异常数"><a href="#3-3-异常数" class="headerlink" title="3.3 异常数"></a>3.3 异常数</h3><p><img src="/2020/11/24/SpringCloud-10/image-20210324142708044.png" alt="image-20210324142708044"></p>
<p>时间窗口一定要大于60秒</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324142648446.png" alt="image-20210324142648446"></p>
<p>异常数是按分钟统计的</p>
<p>测试代码：</p>
<pre><code class="java">@RestController
@Slf4j
public class FlowLimitController
&#123;
    @GetMapping(&quot;/testA&quot;)
    public String testA()
    &#123;
        return &quot;------testA&quot;;
    &#125;

    @GetMapping(&quot;/testB&quot;)
    public String testB()
    &#123;
        log.info(Thread.currentThread().getName()+&quot;\t&quot;+&quot;...testB&quot;);
        return &quot;------testB&quot;;
    &#125;
    @GetMapping(&quot;/testD&quot;)
    public String testD()
    &#123;
//        try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;
//        log.info(&quot;testD 测试RT&quot;);

        log.info(&quot;testD 异常比例&quot;);
        int age = 10/0;
        return &quot;------testD&quot;;
    &#125;
    @GetMapping(&quot;/testE&quot;)
    public String testE()
    &#123;
        log.info(&quot;testE 测试异常数&quot;);
        int age = 10/0;
        return &quot;------testE 测试异常数&quot;;
    &#125;
&#125;
</code></pre>
<p>配置：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324143355535.png" alt="image-20210324143355535"></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8401/testE%EF%BC%8C%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E7%BB%9D%E5%AF%B9%E6%8A%A5%E9%94%99%EF%BC%8C%E5%9B%A0%E4%B8%BA%E9%99%A4%E6%95%B0%E4%B8%8D%E8%83%BD%E4%B8%BA%E9%9B%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8B%E5%88%B0error%E7%AA%97%E5%8F%A3%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BE%BE%E5%88%B05%E6%AC%A1%E6%8A%A5%E9%94%99%E5%90%8E%EF%BC%8C%E8%BF%9B%E5%85%A5%E7%86%94%E6%96%AD%E5%90%8E%E9%99%8D%E7%BA%A7">http://localhost:8401/testE，第一次访问绝对报错，因为除数不能为零，我们看到error窗口，但是达到5次报错后，进入熔断后降级</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324143928282.png" alt="image-20210324143928282"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324143759722.png" alt="image-20210324143759722"></p>
<h2 id="4、热点Key限流"><a href="#4、热点Key限流" class="headerlink" title="4、热点Key限流"></a>4、热点Key限流</h2><p><img src="/2020/11/24/SpringCloud-10/image-20210324144028937.png" alt="image-20210324144028937"></p>
<p>兜底方法分为系统默认和客户自定义两种，</p>
<p>之前的case，限流出问题之后，都是用Sentinel系统默认的提示：Blocked by Sentinel(flow limiting)</p>
<p>我们能够自定义，类似Hystrix，某个方法出问题了，就找对应的兜底降级方法。</p>
<p>从HystrixCommand到@SentinelResource</p>
<p>测试代码：</p>
<pre><code class="java">@RestController
@Slf4j
public class FlowLimitController
&#123;
    @GetMapping(&quot;/testA&quot;)
    public String testA()
    &#123;
        return &quot;------testA&quot;;
    &#125;

    @GetMapping(&quot;/testB&quot;)
    public String testB()
    &#123;
        log.info(Thread.currentThread().getName()+&quot;\t&quot;+&quot;...testB&quot;);
        return &quot;------testB&quot;;
    &#125;
    @GetMapping(&quot;/testD&quot;)
    public String testD()
    &#123;
//        try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;
//        log.info(&quot;testD 测试RT&quot;);

        log.info(&quot;testD 异常比例&quot;);
        int age = 10/0;
        return &quot;------testD&quot;;
    &#125;
    @GetMapping(&quot;/testE&quot;)
    public String testE()
    &#123;
        log.info(&quot;testE 测试异常数&quot;);
        int age = 10/0;
        return &quot;------testE 测试异常数&quot;;
    &#125;
    @GetMapping(&quot;/testHotKey&quot;)
    @SentinelResource(value = &quot;testHotKey&quot;,blockHandler = &quot;deal_testHotKey&quot;)
    public String testHotKey(@RequestParam(value = &quot;p1&quot;,required = false) String p1,
                             @RequestParam(value = &quot;p2&quot;,required = false) String p2)
    &#123;
        //int age = 10/0;
        return &quot;------testHotKey&quot;;
    &#125;
    public String deal_testHotKey (String p1, String p2, BlockException exception)
    &#123;
        return &quot;------deal_testHotKey,o(╥﹏╥)o&quot;;  //sentinel系统默认的提示：Blocked by Sentinel (flow limiting)
    &#125;
&#125;
</code></pre>
<p>配置：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324150822616.png" alt="image-20210324150822616"></p>
<p>结果：第0个参数p1加了限制，一秒内点击超过1则降级处理</p>
<ul>
<li><code>@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;dealHandler_testHotKey&quot;)</code>出现自定义的兜底方法dealHandler_testHotKey</li>
<li><code>@SentinelResource(value = &quot;testHotKey&quot;)</code>出现默认的兜底方法显示error page，会将异常打到前台</li>
</ul>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324151003428.png" alt="image-20210324151003428"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324151808585.png" alt="image-20210324151808585"></p>
<h3 id="4-1-参数例外项"><a href="#4-1-参数例外项" class="headerlink" title="4.1 参数例外项"></a>4.1 参数例外项</h3><p>上述例子演示了第一个参数p1，当QPS超过1秒1次点击后马上被限流</p>
<p>特殊情况：</p>
<ul>
<li>普通：超过1秒后，达到阈值1后马上被限流</li>
<li>我们期望当p1参数当它是某个特殊值时，它的限流和平时不一样</li>
<li>例如，加入p1值为5时，它的阈值达到200</li>
</ul>
<p>配置：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324153040177.png" alt="image-20210324153040177"></p>
<p>此时当p1等与5时，阈值为200，当p1不为5时，阈值变为平常的1</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324153309437.png" alt="image-20210324153309437"></p>
<p><strong>注意点：</strong>热点参数必须是基本类型或者String</p>
<h2 id="5、系统规则"><a href="#5、系统规则" class="headerlink" title="5、系统规则"></a>5、系统规则</h2><p><img src="/2020/11/24/SpringCloud-10/image-20210324154302335.png" alt="image-20210324154302335"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324154617818.png" alt="image-20210324154617818"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324154741268.png" alt="image-20210324154741268"></p>
<p>配置：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324155013852.png" alt="image-20210324155013852"></p>
<p>此时表示全局配置，只要1秒高于阈值，不管是testA，还是testB都熔断降级</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324155146013.png" alt="image-20210324155146013"></p>
<h2 id="6、-SentinelResource"><a href="#6、-SentinelResource" class="headerlink" title="6、@SentinelResource"></a>6、@SentinelResource</h2><h3 id="6-1-按资源名称限流-后序处理"><a href="#6-1-按资源名称限流-后序处理" class="headerlink" title="6.1 按资源名称限流+后序处理"></a>6.1 按资源名称限流+后序处理</h3><p>首先启动Nacos，Sentinel</p>
<p>修改Module：<code>cloudalibaba-sentinel-server8401</code></p>
<p>POM添加：</p>
<pre><code class="xml">&lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;
            &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;
            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<p>YML不变</p>
<p>业务类增加RateLimitController</p>
<pre><code class="java">@RestController
public class RateLimitController
&#123;
    @GetMapping(&quot;/byResource&quot;)
    @SentinelResource(value = &quot;byResource&quot;,blockHandler = &quot;handleException&quot;)
    public CommonResult byResource()
    &#123;
        return new CommonResult(200,&quot;按资源名称限流测试OK&quot;,new Payment(2020L,&quot;serial001&quot;));
    &#125;
    public CommonResult handleException(BlockException exception)
    &#123;
        return new CommonResult(444,exception.getClass().getCanonicalName()+&quot;\t 服务不可用&quot;);
    &#125;
&#125;
</code></pre>
<p><strong>配置流程规则：</strong></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324160615707.png" alt="image-20210324160615707"></p>
<p>表示1秒钟内查询次数大于1，就跑到我们自定义的处理信息，限流发生</p>
<p>测试：1秒钟点击一次，可以，一秒钟点击多次，限流发生</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324160734940.png" alt="image-20210324160734940"></p>
<h3 id="6-2-按URL地址限流-后序处理"><a href="#6-2-按URL地址限流-后序处理" class="headerlink" title="6.2 按URL地址限流+后序处理"></a>6.2 按URL地址限流+后序处理</h3><p>通过访问的URL限流,会返回Sentinel自带默认的限流处理信息</p>
<p>增加业务类RateLimitController代码</p>
<pre><code class="java">@GetMapping(&quot;/rateLimit/byUrl&quot;)
    @SentinelResource(value = &quot;byUrl&quot;)
    public CommonResult byUrl()
    &#123;
        return new CommonResult(200,&quot;按url限流测试OK&quot;,new Payment(2020L,&quot;serial002&quot;));
    &#125;
</code></pre>
<p>配置流程规则：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324161527888.png" alt="image-20210324161527888"></p>
<p>此时资源名为URL地址，表示1秒钟内查询次数大于1，就会限流发生，我们没有自定义限流规则，是默认的页面</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324161637020.png" alt="image-20210324161637020"></p>
<p><strong>上述两种方式的问题：</strong></p>
<ol>
<li>系统默认的，没有体现我们自给的业务要求</li>
<li>依照现有条件，我们自定义的处理方法又和业务代码耦合在一块，不直观</li>
<li>每个业务方法都添加一个兜底的，那代码膨胀加剧</li>
<li>全局统一的处理方法没有体现</li>
</ol>
<h3 id="6-3-用户自定义限流处理逻辑"><a href="#6-3-用户自定义限流处理逻辑" class="headerlink" title="6.3 用户自定义限流处理逻辑"></a>6.3 用户自定义限流处理逻辑</h3><ul>
<li><p>创建CustomerBlockHandler类用于自定义限流处理逻辑</p>
<pre><code class="java">package com.practice.springcloud.alibaba.myhandler;

import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.practice.springcloud.entities.CommonResult;

public class CustomerBlockHandler
&#123;
    public static CommonResult handlerException(BlockException exception)
    &#123;
        return new CommonResult(4444,&quot;按客戶自定义,global handlerException----1&quot;);
    &#125;
    public static CommonResult handlerException2(BlockException exception)
    &#123;
        return new CommonResult(4444,&quot;按客戶自定义,global handlerException----2&quot;);
    &#125;
&#125;
</code></pre>
</li>
<li><p>修改业务类RateLimitController</p>
<pre><code class="java">package com.practice.springcloud.alibaba.controller;


import com.alibaba.csp.sentinel.annotation.SentinelResource;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.practice.springcloud.alibaba.myhandler.CustomerBlockHandler;
import com.practice.springcloud.entities.CommonResult;
import com.practice.springcloud.entities.Payment;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class RateLimitController
&#123;
    @GetMapping(&quot;/byResource&quot;)
    @SentinelResource(value = &quot;byResource&quot;,blockHandler = &quot;handleException&quot;)
    public CommonResult byResource()
    &#123;
        return new CommonResult(200,&quot;按资源名称限流测试OK&quot;,new Payment(2020L,&quot;serial001&quot;));
    &#125;
    public CommonResult handleException(BlockException exception)
    &#123;
        return new CommonResult(444,exception.getClass().getCanonicalName()+&quot;\t 服务不可用&quot;);
    &#125;
    @GetMapping(&quot;/rateLimit/byUrl&quot;)
    @SentinelResource(value = &quot;byUrl&quot;)
    public CommonResult byUrl()
    &#123;
        return new CommonResult(200,&quot;按url限流测试OK&quot;,new Payment(2020L,&quot;serial002&quot;));
    &#125;
    @GetMapping(&quot;/rateLimit/customerBlockHandler&quot;)
    @SentinelResource(value = &quot;customerBlockHandler&quot;,
            blockHandlerClass = CustomerBlockHandler.class,
            blockHandler = &quot;handlerException2&quot;)
    public CommonResult customerBlockHandler()
    &#123;
        return new CommonResult(200,&quot;按客戶自定义&quot;,new Payment(2020L,&quot;serial003&quot;));
    &#125;
&#125;
</code></pre>
</li>
<li><p>启动服务，先调用一次<a target="_blank" rel="noopener" href="http://localhost:8401/rateLimit/customerBlockHandler">http://localhost:8401/rateLimit/customerBlockHandler</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324164045293.png" alt="image-20210324164045293"></p>
</li>
<li><p>设置限流</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324164151463.png" alt="image-20210324164151463"></p>
</li>
<li><p>再测试，用户自定义</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324164217160.png" alt="image-20210324164217160"></p>
</li>
<li><p>说明：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324164329276.png" alt="image-20210324164329276"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324164739589.png" alt="image-20210324164739589"></p>
</li>
</ul>
<h2 id="7、服务熔断功能"><a href="#7、服务熔断功能" class="headerlink" title="7、服务熔断功能"></a>7、服务熔断功能</h2><p>Sentinel整合ribbon+openFeign+fallback</p>
<h3 id="7-1-Ribbon系列"><a href="#7-1-Ribbon系列" class="headerlink" title="7.1 Ribbon系列"></a>7.1 Ribbon系列</h3><p>启动Nacos和Sentinel</p>
<p>新建服务提供者Module：<code>cloudalibaba-provider-payment9003/9004</code></p>
<p>POM：</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;cloud2020&lt;/artifactId&gt;
        &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;cloudalibaba-provider-payment9003&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;!--SpringCloud ailibaba nacos --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;
            &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;
            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringBoot整合Web组件 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--日常通用jar包配置--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<p>YML：</p>
<pre><code class="yml">server:
  port: 9003

spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #配置Nacos地址

management:
  endpoints:
    web:
      exposure:
        include: &#39;*&#39;
</code></pre>
<p>主启动类</p>
<pre><code class="java">package com.practice.springcloud.alibaba;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class PaymentMain9003
&#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(PaymentMain9003.class, args);
    &#125;
&#125;
</code></pre>
<p>业务类：controller</p>
<pre><code class="java">@RestController
public class PaymentController
&#123;
    @Value(&quot;$&#123;server.port&#125;&quot;)
    private String serverPort;

    public static HashMap&lt;Long, Payment&gt; hashMap = new HashMap&lt;&gt;();
    static
    &#123;
        hashMap.put(1L,new Payment(1L,&quot;28a8c1e3bc2742d8848569891fb42181&quot;));
        hashMap.put(2L,new Payment(2L,&quot;bba8c1e3bc2742d8848569891ac32182&quot;));
        hashMap.put(3L,new Payment(3L,&quot;6ua8c1e3bc2742d8848569891xt92183&quot;));
    &#125;

    @GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)
    public CommonResult&lt;Payment&gt; paymentSQL(@PathVariable(&quot;id&quot;) Long id)
    &#123;
        Payment payment = hashMap.get(id);
        CommonResult&lt;Payment&gt; result = new CommonResult(200,&quot;from mysql,serverPort:  &quot;+serverPort,payment);
        return result;
    &#125;
&#125;
</code></pre>
<p>测试地址：<a target="_blank" rel="noopener" href="http://localhost:9003/paymentSQL/1">http://localhost:9003/paymentSQL/1</a></p>
<p>9004与9003一致</p>
<p>新建服务消费者Module：<code>cloudalibaba-consumer-nacos-order84</code></p>
<p>POM：</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;cloud2020&lt;/artifactId&gt;
        &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;cloudalibaba-consumer-nacos-order84&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;!--SpringCloud openfeign --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--SpringCloud ailibaba nacos --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--SpringCloud ailibaba sentinel --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.practice.springcloud&lt;/groupId&gt;
            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;
            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringBoot整合Web组件 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--日常通用jar包配置--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<p>YML：</p>
<pre><code class="yml">server:
  port: 84


spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    sentinel:
      transport:
        #配置Sentinel dashboard地址
        dashboard: localhost:8080
        #默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口
        port: 8719

#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)
service-url:
  nacos-user-service: http://nacos-payment-provider
</code></pre>
<p>业务类：</p>
<p>ApplicationContextConfig</p>
<pre><code class="java">package com.practice.springcloud.alibaba.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class ApplicationContextConfig
&#123;
    @Bean
    @LoadBalanced
    public RestTemplate getRestTemplate()
    &#123;
        return new RestTemplate();
    &#125;
&#125;
</code></pre>
<p>CircleBreakController：</p>
<pre><code class="java">@RestController
@Slf4j
public class CircleBreakerController
&#123;
    public static final String SERVICE_URL = &quot;http://nacos-payment-provider&quot;;

    @Resource
    private RestTemplate restTemplate;

    @RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)
    @SentinelResource(value = &quot;fallback&quot;) //没有配置
    public CommonResult&lt;Payment&gt; fallback(@PathVariable Long id)
    &#123;
        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + &quot;/paymentSQL/&quot;+id,CommonResult.class,id);

        if (id == 4) &#123;
            throw new IllegalArgumentException (&quot;IllegalArgumentException,非法参数异常....&quot;);
        &#125;else if (result.getData() == null) &#123;
            throw new NullPointerException (&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;);
        &#125;

        return result;
    &#125;
&#125;
</code></pre>
<p>主启动类：</p>
<pre><code class="java">@EnableDiscoveryClient
@SpringBootApplication
public class OrderNacosMain84
&#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(OrderNacosMain84.class, args);
    &#125;
&#125;
</code></pre>
<p>测试地址：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/1%EF%BC%8C%E5%8F%91%E7%8E%B09003,9004%E7%AB%AF%E5%8F%A3%E4%BA%A4%E6%9B%BF%E5%87%BA%E7%8E%B0%EF%BC%8C%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">http://localhost:84/consumer/fallback/1，发现9003,9004端口交替出现，实现负载均衡</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324183001040.png" alt="image-20210324183001040"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324183015615.png" alt="image-20210324183015615"></p>
<h4 id="7-1-1-没有任何配置"><a href="#7-1-1-没有任何配置" class="headerlink" title="7.1.1 没有任何配置"></a>7.1.1 没有任何配置</h4><p>此时，上述程序什么都没有配置：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324200454067.png" alt="image-20210324200454067"></p>
<p>如果输入4会报非法参数异常，输入4之外的会报空指针异常(1,2,3，数据库中有，会查到正常数据)</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324200741518.png" alt="image-20210324200741518"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324200801379.png" alt="image-20210324200801379"></p>
<p>这种情况无熔断，无降级，直接给前端客户返回error界面，非常不友好</p>
<h4 id="7-1-2-只配置fallback"><a href="#7-1-2-只配置fallback" class="headerlink" title="7.1.2 只配置fallback"></a>7.1.2 只配置fallback</h4><p><strong>fallback方法管理运行异常，相当于服务降级</strong></p>
<p>此时加一个fallback方法，加一个异常处理的兜底方法</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324201323581.png" alt="image-20210324201323581"></p>
<p>此时再访问4或其他产生异常的数字</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324201440608.png" alt="image-20210324201440608"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324201423890.png" alt="image-20210324201423890"></p>
<p>此时，这两个页面相对于之前的error页面，就显得比较友好了</p>
<h4 id="7-1-3-只配置blockHandler"><a href="#7-1-3-只配置blockHandler" class="headerlink" title="7.1.3 只配置blockHandler"></a>7.1.3 只配置blockHandler</h4><p><img src="/2020/11/24/SpringCloud-10/image-20210324202041834.png" alt="image-20210324202041834"></p>
<p>blockHandler只负责sentinel控制台配置违规</p>
<p>此时正常访问</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324202352729.png" alt="image-20210324202352729"></p>
<p>配置Sentinel：表示1秒内阈值最大为1</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324202617127.png" alt="image-20210324202617127"></p>
<p>此时再点击<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/5">http://localhost:84/consumer/fallback/5</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324202709809.png" alt="image-20210324202709809"></p>
<p>此时单击一下则出现error页面，因为这是运行时异常，fallback没设，而blockHandler管不了，所以会报error页面。</p>
<p>此时如果快速点击，则返回异常页面，因为此时已经超过Sentinel设定的最大阈值，所以跳到Sentinel控制的页面，也就是blockHandler所设置的方法</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324202910696.png" alt="image-20210324202910696"></p>
<h4 id="7-1-4-两个都配置"><a href="#7-1-4-两个都配置" class="headerlink" title="7.1.4 两个都配置"></a>7.1.4 两个都配置</h4><p><img src="/2020/11/24/SpringCloud-10/image-20210324203333500.png" alt="image-20210324203333500"></p>
<p>设定Sentinel配置</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324203549954.png" alt="image-20210324203549954"></p>
<p>此时如果每秒访问超过阈值，会报限流</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324203624772.png" alt="image-20210324203624772"></p>
<p>此时如果访问4，产生运行时异常，会显示fallback的兜底方法</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324203657736.png" alt="image-20210324203657736"></p>
<p>此时如果一秒内多次访问4，虽然有异常，但仍会被Sentinel拦截，显示blockHandler设定的方法</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324203814377.png" alt="image-20210324203814377"></p>
<p>所以，若blockHandler和fallback都进行了配置，则被限流级而抛出BlockException时只会进入blockHandler处理逻辑</p>
<h4 id="7-1-5-异常忽略"><a href="#7-1-5-异常忽略" class="headerlink" title="7.1.5 异常忽略"></a>7.1.5 异常忽略</h4><p><img src="/2020/11/24/SpringCloud-10/image-20210324204513619.png" alt="image-20210324204513619"></p>
<p>此时4的异常被忽略，不会fallback降级</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324204725384.png" alt="image-20210324204725384"></p>
<h3 id="7-2-OpenFeign系列"><a href="#7-2-OpenFeign系列" class="headerlink" title="7.2 OpenFeign系列"></a>7.2 OpenFeign系列</h3><p>修改84模块</p>
<ul>
<li>84消费者调用提供者9003，Feign组件一般是消费侧</li>
</ul>
<p>POM：加入依赖</p>
<pre><code class="xml"> &lt;!--SpringCloud openfeign --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<p>YML：</p>
<pre><code class="yml"># 激活Sentinel对Feign的支持
feign:
  sentinel:
    enabled: true
</code></pre>
<p>业务类Service:</p>
<p>PaymentService:</p>
<pre><code class="java">package com.practice.springcloud.alibaba.service;

import com.practice.springcloud.entities.CommonResult;
import com.practice.springcloud.entities.Payment;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(value = &quot;nacos-payment-provider&quot;,fallback = PaymentFallbackService.class)
public interface PaymentService
&#123;
    @GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)
    public CommonResult&lt;Payment&gt; paymentSQL(@PathVariable(&quot;id&quot;) Long id);
&#125;
</code></pre>
<p>PaymentFallbackService:</p>
<pre><code class="java">@Component
public class PaymentFallbackService implements PaymentService
&#123;
    @Override
    public CommonResult&lt;Payment&gt; paymentSQL(Long id)
    &#123;
        return new CommonResult&lt;&gt;(44444,&quot;服务降级返回,---PaymentFallbackService&quot;,new Payment(id,&quot;errorSerial&quot;));
    &#125;
&#125;
</code></pre>
<p>业务类Controller：</p>
<pre><code class="java"> @Resource
    private PaymentService paymentService;

    @GetMapping(value = &quot;/consumer/paymentSQL/&#123;id&#125;&quot;)
    public CommonResult&lt;Payment&gt; paymentSQL(@PathVariable(&quot;id&quot;) Long id)
    &#123;
        return paymentService.paymentSQL(id);
    &#125;
</code></pre>
<p>主启动类：</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324205611681.png" alt="image-20210324205611681"></p>
<p>运行测试：9004,9003轮询切换</p>
<p><a target="_blank" rel="noopener" href="http://localhost:84/consumer/paymentSQL/1">http://localhost:84/consumer/paymentSQL/1</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324210022034.png" alt="image-20210324210022034"></p>
<p>测试当9003/9004关闭，看84消费侧是否会自动降级，不会被耗死</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324211043247.png" alt="image-20210324211043247"></p>
<p>再访问<a target="_blank" rel="noopener" href="http://localhost:84/consumer/paymentSQL/1">http://localhost:84/consumer/paymentSQL/1</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324210943831.png" alt="image-20210324210943831"></p>
<p>发现服务自动降级</p>
<p>熔断框架比较</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324211135489.png" alt="image-20210324211135489"></p>
<h2 id="8、Sentinel持久化"><a href="#8、Sentinel持久化" class="headerlink" title="8、Sentinel持久化"></a>8、Sentinel持久化</h2><p>是什么？</p>
<ul>
<li>一旦我们重启应用,sentinel规则消失,生产环境需要将配置规则进行持久化</li>
</ul>
<p>怎么用？</p>
<ul>
<li>将限流规则持久进Nacos保存,只要刷新8401某个rest地址,sentinel控制台的流控规则就能看得到,只要Nacos里面的配置不删除,针对8401上的流控规则持续有效</li>
</ul>
<p>修改cloudalibaba-sentinel-server8401</p>
<ul>
<li>POM：添加nacos依赖</li>
</ul>
<pre><code class="xml">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;
            &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<ul>
<li>YML，添加Nacos数据源配置</li>
</ul>
<pre><code class="yml">server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #Nacos服务注册中心地址
    sentinel:
      transport:
        dashboard: localhost:8080 #配置Sentinel dashboard地址
        port: 8719
      datasource:
        ds1:
          nacos:
            server-addr: localhost:8848
            dataId: cloudalibaba-sentinel-service
            groupId: DEFAULT_GROUP
            data-type: json
            rule-type: flow

management:
  endpoints:
    web:
      exposure:
        include: &#39;*&#39;

feign:
  sentinel:
    enabled: true # 激活Sentinel对Feign的支持
</code></pre>
<ul>
<li>添加Nacos的业务规则配置</li>
</ul>
<pre><code class="json">[
    &#123;
        &quot;resource&quot;: &quot;/rateLimit/byUrl&quot;,
        &quot;limitApp&quot;: &quot;default&quot;,
        &quot;grade&quot;: 1,
        &quot;count&quot;: 1,
        &quot;stragegy&quot;: 0,
        &quot;controlBehavior&quot;: 0,
        &quot;clusterMode&quot;: false
    &#125;
]
</code></pre>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324212807465.png" alt="image-20210324212807465"></p>
<p>启动8401刷新Sentinel发现业务规则变了</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8401/rateLimit/byUrl">http://localhost:8401/rateLimit/byUrl</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324212948486.png" alt="image-20210324212948486"></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324213041319.png" alt="image-20210324213041319"></p>
<p>此时多次刷新，发现触发流控规则</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324213423416.png" alt="image-20210324213423416"></p>
<p>看看是否持久化：</p>
<p>关闭8401，此时流控规则没有了</p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324213534477.png" alt="image-20210324213534477"></p>
<p>再启动8401，多次访问<a target="_blank" rel="noopener" href="http://localhost:8401/rateLimit/byUrl%EF%BC%8C%E5%86%8D%E6%9F%A5%E7%9C%8B%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%87%BA%E7%8E%B0%E4%BA%86">http://localhost:8401/rateLimit/byUrl，再查看流控规则，发现出现了</a></p>
<p><img src="/2020/11/24/SpringCloud-10/image-20210324213703263.png" alt="image-20210324213703263"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SpringCloud/" rel="tag"># SpringCloud</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/11/23/SpringCloud-09/" rel="prev" title="SpringCloud-09(nacos服务注册与配置中心)">
                  <i class="fa fa-chevron-left"></i> SpringCloud-09(nacos服务注册与配置中心)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/25/SpringCloud-11/" rel="next" title="SpringCloud-11(Seata分布式事务)">
                  SpringCloud-11(Seata分布式事务) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wyc</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>


    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  

</body>
</html>
